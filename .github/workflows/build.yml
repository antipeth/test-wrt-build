name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "版本类型"
        required: true
        default: "stable"
        type: choice
        options:
          - "snapshot"
          - "stable"
      branch:
        description: "snapshot 分支 (仅当 version_type=snapshot 时使用)"
        required: false
        default: "master"
        type: string
      tag:
        description: "stable Tag (仅当 version_type=stable 时使用)"
        required: false
        default: "v24.10.2"
        type: string
      config_path:
        description: "OpenWrt 配置文件路径（相对于仓库根目录）"
        required: true
        default: "config/openwrt-linksys-e8450"
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Git ref
        id: refinfo
        run: |
          if [ "${{ inputs.version_type }}" = "snapshot" ]; then
            echo "ref=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gettext git \
            libncurses-dev libssl-dev python3 python3-dev python3-setuptools \
            rsync unzip zlib1g-dev file wget curl \
            gzip tar zip xz-utils bzip2 zstd \
            make cmake autoconf automake libtool patch diffutils \
            findutils grep sed help2man texinfo \
            libelf-dev libfuse-dev liblzma-dev libxml2-dev libyaml-dev \
            uuid-dev device-tree-compiler antlr3 gperf \
            time bc jq xxd swig upx-ucl ccache ecj fastjar imagemagick

      - name: Clone OpenWrt source
        run: |
          echo "📥 克隆 OpenWrt 源 (ref=${{ steps.refinfo.outputs.ref }})"
          git clone --depth 1 --branch "${{ steps.refinfo.outputs.ref }}" \
            https://git.openwrt.org/openwrt/openwrt.git openwrt

      - name: Update & install feeds
        working-directory: openwrt
        run: |
          echo "📦 更新 Feeds（带重试）"
          retries=3
          until ./scripts/feeds update -a; do
            retries=$((retries-1))
            if [ $retries -le 0 ]; then
              echo "❌ 更新 feeds 多次失败，退出"
              exit 1
            fi
            echo "⚠️ 更新失败，剩余重试次数：$retries，5s 后重试..."
            sleep 5
          done
          echo "📦 安装 Feeds"
          ./scripts/feeds install -a || true

      - name: Setup configuration
        run: |
          echo "📋 复制配置：${{ inputs.config_path }} → openwrt/.config"
          if [ ! -f "${{ inputs.config_path }}" ]; then
            echo "❌ 配置文件未找到: ${{ inputs.config_path }}" >&2
            exit 1
          fi
          cp "${{ inputs.config_path }}" openwrt/.config
          cd openwrt
          echo "🔄 执行 make oldconfig"
          make oldconfig

      - name: Download source packages
        working-directory: openwrt
        run: |
          echo "⬇️ 下载源码包"
          make download -j$(nproc)

      - name: Compile firmware
        working-directory: openwrt
        run: |
          JOBS=$(nproc)
          echo "🚀 开始编译 (并行: ${JOBS})"
          if ! time make world -j${JOBS} V=s 2>&1 | tee build.log; then
            echo "❌ 编译失败，输出最后 100 行日志："
            tail -n 100 build.log
            exit 1
          fi
          echo "✅ 编译成功"

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-artifacts
          path: |
            openwrt/bin/targets/**/*.{img,bin,tar.gz,zip,itb}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: openwrt/build.log
