name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "ç‰ˆæœ¬ç±»å‹"
        required: true
        default: "stable"
        type: choice
        options:
          - "snapshot"
          - "stable"
      branch:
        description: "snapshot åˆ†æ”¯ (ä»…å½“ version_type=snapshot æ—¶ä½¿ç”¨)"
        required: false
        default: "master"
        type: string
      tag:
        description: "stable Tag (ä»…å½“ version_type=stable æ—¶ä½¿ç”¨)"
        required: false
        default: "v24.10.2"
        type: string
      config_path:
        description: "OpenWrt é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ï¼‰"
        required: true
        default: "config/openwrt-linksys-e8450"
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Git ref
        id: refinfo
        run: |
          if [ "${{ inputs.version_type }}" = "snapshot" ]; then
            echo "ref=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gettext git \
            libncurses-dev libssl-dev python3 python3-dev python3-setuptools \
            rsync unzip zlib1g-dev file wget curl \
            gzip tar zip xz-utils bzip2 zstd \
            make cmake autoconf automake libtool patch diffutils \
            findutils grep sed help2man texinfo \
            libelf-dev libfuse-dev liblzma-dev libxml2-dev libyaml-dev \
            uuid-dev device-tree-compiler antlr3 gperf \
            time bc jq xxd swig upx-ucl ccache ecj fastjar imagemagick

      - name: Clone OpenWrt source
        run: |
          echo "ğŸ“¥ å…‹éš† OpenWrt æº (ref=${{ steps.refinfo.outputs.ref }})"
          git clone --depth 1 --branch "${{ steps.refinfo.outputs.ref }}" \
            https://git.openwrt.org/openwrt/openwrt.git openwrt

      - name: Update & install feeds
        working-directory: openwrt
        run: |
          echo "ğŸ“¦ æ›´æ–° Feedsï¼ˆå¸¦é‡è¯•ï¼‰"
          retries=3
          until ./scripts/feeds update -a; do
            retries=$((retries-1))
            if [ $retries -le 0 ]; then
              echo "âŒ æ›´æ–° feeds å¤šæ¬¡å¤±è´¥ï¼Œé€€å‡º"
              exit 1
            fi
            echo "âš ï¸ æ›´æ–°å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š$retriesï¼Œ5s åé‡è¯•..."
            sleep 5
          done
          echo "ğŸ“¦ å®‰è£… Feeds"
          ./scripts/feeds install -a || true

      - name: Setup configuration
        run: |
          echo "ğŸ“‹ å¤åˆ¶é…ç½®ï¼š${{ inputs.config_path }} â†’ openwrt/.config"
          if [ ! -f "${{ inputs.config_path }}" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°: ${{ inputs.config_path }}" >&2
            exit 1
          fi
          cp "${{ inputs.config_path }}" openwrt/.config
          cd openwrt
          echo "ğŸ”„ æ‰§è¡Œ make oldconfig"
          make oldconfig

      - name: Download source packages
        working-directory: openwrt
        run: |
          echo "â¬‡ï¸ ä¸‹è½½æºç åŒ…"
          make download -j$(nproc)

      - name: Compile firmware
        working-directory: openwrt
        run: |
          JOBS=$(nproc)
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ (å¹¶è¡Œ: ${JOBS})"
          if ! time make world -j${JOBS} V=s 2>&1 | tee build.log; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¾“å‡ºæœ€å 100 è¡Œæ—¥å¿—ï¼š"
            tail -n 100 build.log
            exit 1
          fi
          echo "âœ… ç¼–è¯‘æˆåŠŸ"

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-artifacts
          path: |
            openwrt/bin/targets/**/*.{img,bin,tar.gz,zip,itb}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: openwrt/build.log
